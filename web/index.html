<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kollect</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="https://unpkg.com/@material-ui/core@4.11.4/dist/material-ui.min.css" />
    <script src="https://unpkg.com/htmx.org@1.7.0"></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.7"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        .container {
            padding: 20px;
        }
        .logo {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 10%; 
        }
        .table-container {
            margin-top: 20px;
        }
        table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
            box-shadow: 0px 0px 20px rgba(0,0,0,0.15);
        }
        th, td {
            border: 1px solid #dddddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #3c413c;
            color: white;
        }
        .export-button {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="kollect.png" alt="Logo" class="logo">
        <div class="export-button">
            <button id="export-button" class="MuiButtonBase-root MuiButton-root MuiButton-contained MuiButton-containedPrimary">
                Export Data
            </button>
        </div>
        <div id="hidden-content" hx-get="/api/data" hx-trigger="load" hx-target="#hidden-content" hx-swap="innerHTML" style="display: none;"></div>
        <div id="content" class="table-container">
            <!-- Tables will be added here by JavaScript -->
        </div>
    </div>
    <template id="table-template">
        <table>
            <thead>
                <tr>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added here by JavaScript -->
            </tbody>
        </table>
    </template>
    <script>
        document.addEventListener('htmx:afterSwap', (event) => {
            if (event.detail.target.id === 'hidden-content') {
                try {
                    const data = JSON.parse(event.detail.xhr.responseText);
                    console.log("Fetched Data:", data); // Log fetched data
                    const content = document.getElementById('content');
                    const template = document.getElementById('table-template').content;

                    function createTable(headerText, data, rowTemplate, headers) {
                        if (!data) return; // Ensure data is not null or undefined
                        const table = template.cloneNode(true);
                        table.querySelector('th').textContent = headerText;
                        const thead = table.querySelector('thead');
                        const headerRow = document.createElement('tr');
                        headers.forEach(header => {
                            const th = document.createElement('th');
                            th.textContent = header;
                            headerRow.appendChild(th);
                        });
                        thead.appendChild(headerRow);
                        const tbody = table.querySelector('tbody');
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = rowTemplate(item);
                            tbody.appendChild(row);
                        });
                        content.appendChild(table);
                    }

                    function nodeRowTemplate(item) {
                        return `<td>${item.Name}</td><td>${item.Roles}</td><td>${item.Age}</td><td>${item.Version}</td><td>${item.OSImage}</td>`;
                    }

                    function defaultRowTemplate(item) {
                        return `<td>${item}</td>`;
                    }

                    function podRowTemplate(item) {
                        return `<td>${item.Name}</td><td>${item.Namespace}</td><td>${item.Status}</td>`;
                    }

                    function deploymentRowTemplate(item) {
                        return `<td>${item.Name}</td><td>${item.Namespace}</td><td>${item.Containers.join(', ')}</td><td>${item.Images.join(', ')}</td>`;
                    }

                    function stsRowTemplate(item) {
                        return `<td>${item.Name}</td><td>${item.Namespace}</td><td>${item.ReadyReplicas}</td><td>${item.Image}</td>`;
                    }

                    function serviceRowTemplate(item) {
                        return `<td>${item.Name}</td><td>${item.Namespace}</td><td>${item.Type}</td><td>${item.ClusterIP}</td><td>${item.Ports}</td>`;
                    }

                    function perVolRowTemplate(item) {
                        return `<td>${item.Name}</td><td>${item.Capacity}</td><td>${item.AccessModes}</td><td>${item.Status}</td><td>${item.AssociatedClaim}</td><td>${item.StorageClass}</td><td>${item.VolumeMode}</td>`;
                    }

                    function perVolClaimRowTemplate(item) {
                        return `<td>${item.Name}</td><td>${item.Namespace}</td><td>${item.Status}</td><td>${item.Volume}</td><td>${item.Capacity}</td><td>${item.AccessMode}</td><td>${item.StorageClass}</td>`;
                    }

                    function storageClassRowTemplate(item) {
                        return `<td>${item.Name}</td><td>${item.Provisioner}</td><td>${item.VolumeExpansion}</td>`;
                    }

                    function volSnapshotClassRowTemplate(item) {
                        return `<td>${item.Name}</td><td>${item.Driver}</td>`;
                    }

                    function ec2InstanceRowTemplate(item) {
                        return `<td>${item.InstanceID}</td><td>${item.Type}</td><td>${item.State}</td>`;
                    }

                    function s3BucketRowTemplate(item) {
                        return `<td>${item.Name}</td>`;
                    }

                    function rdsInstanceRowTemplate(item) {
                        return `<td>${item.InstanceID}</td><td>${item.Engine}</td><td>${item.Status}</td>`;
                    }

                    function dynamoDBTableRowTemplate(item) {
                        return `<td>${item.TableName}</td><td>${item.Status}</td>`;
                    }

                    function vpcRowTemplate(item) {
                        return `<td>${item.VPCID}</td><td>${item.State}</td>`;
                    }

                    if (data.Nodes) {
                        createTable('Nodes', data.Nodes, nodeRowTemplate, ['Name', 'Roles', 'Age', 'Version', 'OS-Image']);
                    }
                    if (data.Namespaces) {
                        createTable('Namespaces', data.Namespaces, defaultRowTemplate, ['Namespace']);
                    }
                    if (data.Pods) {
                        createTable('Pods', data.Pods, podRowTemplate, ['Pod', 'Namespace', 'Status']);
                    }
                    if (data.Deployments) {
                        createTable('Deployments', data.Deployments, deploymentRowTemplate, ['Deployments', 'Namespace', 'Containers', 'Images']);
                    }
                    if (data.StatefulSets) {
                        createTable('StatefulSets', data.StatefulSets, stsRowTemplate, ['StatefulSet', 'Namespace', 'Ready Replicas','Image']);
                    }
                    if (data.Services) {
                        createTable('Services', data.Services, serviceRowTemplate, ['Service', 'Namespace', 'Type', 'Cluster IP', 'Ports']);
                    }
                    if (data.PersistentVolumes) {
                        createTable('PersistentVolumes', data.PersistentVolumes, perVolRowTemplate, ['PersistentVolume', 'Capacity', 'Access Modes', 'Status', 'Claim', 'StorageClass', 'Volume Mode']);
                    }
                    if (data.PersistentVolumeClaims) {
                        createTable('PersistentVolumeClaims', data.PersistentVolumeClaims, perVolClaimRowTemplate, ['PersistentVolumeClaim', 'Namespace', 'Status', 'Volume', 'Capacity', 'Access Mode', 'StorageClass']);
                    }
                    if (data.StorageClasses) {
                        createTable('StorageClasses', data.StorageClasses, storageClassRowTemplate, ['StorageClass', 'Provisioner', 'Volume Expansion']);
                    }
                    if (data.VolumeSnapshotClasses) {
                        createTable('VolumeSnapshotClasses', data.VolumeSnapshotClasses, volSnapshotClassRowTemplate, ['VolumeSnapshotClass', 'Driver']);
                    }
                    if (data.EC2Instances) {
                        createTable('EC2 Instances', data.EC2Instances, ec2InstanceRowTemplate, ['Instance ID', 'Type', 'State']);
                    }
                    if (data.S3Buckets) {
                        createTable('S3 Buckets', data.S3Buckets, s3BucketRowTemplate, ['Bucket Name']);
                    }
                    if (data.RDSInstances) {
                        createTable('RDS Instances', data.RDSInstances, rdsInstanceRowTemplate, ['Instance ID', 'Engine', 'Status']);
                    }
                    if (data.DynamoDBTables) {
                        createTable('DynamoDB Tables', data.DynamoDBTables, dynamoDBTableRowTemplate, ['Table Name', 'Status']);
                    }
                    if (data.VPCs) {
                        createTable('VPCs', data.VPCs, vpcRowTemplate, ['VPC ID', 'State']);
                    }
                } catch (error) {
                    console.error("Error processing data:", error);
                }
            }
        });

        document.getElementById('export-button').addEventListener('click', () => {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'data.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                })
                .catch(error => console.error('Error exporting data:', error));
        });
    </script>
</body>
</html>